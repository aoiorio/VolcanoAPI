name: 🐼 AWS Lambda Deploy

on:
  push:
    branches:
      # This means that contains every branch
      - '**'

jobs:
  deploy_to_lambda:
    name: 🌋 Deploy FastAPI endpoints to Lambda Function
    runs-on: ubuntu-latest
    # These permissions are needed to interact with GitHub's OIDC Token endpoint.
    permissions:
      id-token: write # This is required for requesting the JWT and you can get some information from JWT
      contents: read # This is required for actions/checkout

    steps:
      - name: 🌚 Checkout
        uses: actions/checkout@v3

      - name: Make EnvFile
        run: |
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> .env

      # Fetch credentials from AWS
      - name: 🍄 Configure aws credential
        uses: aws-actions/configure-aws-credentials@master
        with:
          aws-region: ${{ secrets.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          # Specify the name of user who manupilates AWS Lambda
          role-session-name: GitHubActions

      # Get Account, UserID and Arn of AWS
      - name: 🪼 Allow to run on role.
        run: aws sts get-caller-identity

      - name: 🍌 Setup python
        uses: actions/setup-python@v3
        with:
          # Specify python version (I think it must be the same version as I set in Lambda function)
          python-version: '3.9'

      # Create zip file and upload to Lambda function called sealion
      - name: 🧠 Upload zip file to Lambda function
        # 1. Add DATABASE_URL to .env-dev file and add dotenv path to config.py for lambda
        # 2. Create zip file called aws_lambda_artifact.zip that is including dependencies folders
        # 3. Add app folder to zip file I made
        # 4. Upload the zip file to Lambda function by using aws command.
        run: |
          echo "1. add DATABASE_URL to .env-dev and add dotenv path for lambda"
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> .env-dev
          cd volcano/core
          echo "dotenv_path = Path('.env-dev')
          load_dotenv(dotenv_path=dotenv_path)
          DATABASE_URL = os.getenv(DATABASE_URL)" >> config.py

          echo "2. create zip file"
          cd .dockervenv/lib/python3.9/site-packages && zip -r9 ../../../../aws_lambda_artifact.zip .
          cd -
          zip -g ./aws_lambda_artifact.zip -r .env-dev
          zip -g ./aws_lambda_artifact.zip -r volcano

          echo "3. upload zip file to lambda function"
          aws lambda update-function-code --function-name volcano --zip-file fileb://aws_lambda_artifact.zip --publish
