name: ğŸ¼ AWS Lambda Deploy

on:
  push:
    branches:
      # This means that contains every branch
      - '**'

jobs:
  deploy_to_lambda:
    name: ğŸ‘‘ Deploy FastAPI endpoints to Lambda Function
    runs-on: ubuntu-latest
    # These permissions are needed to interact with GitHub's OIDC Token endpoint.
    permissions:
      id-token: write # This is required for requesting the JWT and you can get some information from JWT
      contents: read # This is required for actions/checkout

    steps:
      - name: ğŸ¡ Checkout
        uses: actions/checkout@v3

      # Fetch credentials from AWS
      - name: ğŸ«• Configure aws credential
        uses: aws-actions/configure-aws-credentials@master
        with:
          aws-region: ${{ secrets.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          # Specify the name of user who manupilates AWS Lambda
          role-session-name: GitHubActions

      # Get Account, UserID and Arn of AWS
      - name: ğŸ“ Allow to run on role.
        run: aws sts get-caller-identity

      - name: ğŸª½ Setup python
        uses: actions/setup-python@v3
        with:
          # Specify python version (I think it must be the same version as I set in Lambda function)
          python-version: '3.12'

      # Create zip file and upload to Lambda function called sealion
      - name: ğŸ§  Upload zip file to Lambda function
        # 1. Move to site-packages directory and create zip file from the files of dependencies on root directory
        # 2. Move to home previous directory
        # 3. Add app folder to zip file I made
        # 4. Upload the zip file to Lambda function by using aws command.
        run: |
          cd .dockervenv/lib/python3.9/site-packages && zip -r9 ../../../../aws_lambda_artifact.zip .
          cd -
          zip -g ./aws_lambda_artifact.zip -r volcano
          aws lambda update-function-code --function-name volcano --zip-file fileb://aws_lambda_artifact.zip --publish